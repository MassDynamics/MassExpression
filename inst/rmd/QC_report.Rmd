---
title: "Mass Dynamics Quality Control Report"
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    fig_caption: yes
    lib_dir: qc_report_files
    df_print: paged
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: false
  always_allow_html: true
params:
  listInt: empty
  experiment: empty
  format: pdf
  output_figure: figures
---


<style type="text/css">

summary {
  text-decoration: underline;
  font-size: 16px;
  color: grey;
  cursor: pointer;
  margin-bottom: 16px;
}

summary, summary:active {
  border: none;
}

details span {
  margin-top: 8px;
  display: block;
}

#header .btn-group {
  display: none;
}

.main-container {
  max-width: 1400px !important;
}
</style>

--- 

```{r setup, include=FALSE}
print(params)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.path = params$output_figure)
```

```{r data-needed, include=FALSE}
library(dplyr)
library(stringr)
library(MassExpression)
library(plotly)

CompleteIntensityExperiment <- params$listInt$CompleteIntensityExperiment
IntensityExperiment <- params$listInt$IntensityExperiment
design <- colData(IntensityExperiment)

#design <- mq_lfq_data$design
#intensities <- mq_lfq_data$intensities
```


<details>
  <summary>More about the QC Report</summary>
  <span>
    <p>
      This QC Report is designed to help Scientists quickly assess the several aspect of experiment quality, There are 4 categories in the QC report:
    </p>
    <ul>
      <li>Experiment Design</li>
      <li>Experiment Health<li>
      <li>Feature Completeness</li>
      <li>Imputation</li>
    </ul>
  </span>
</details> 


# 1. Experiment Design

```{r experimental-design, eval=TRUE, warning=FALSE, echo=FALSE, error=FALSE, message=FALSE, results='asis'}
knitr::kable(design)
```

# 2. Experiment Health

## A. Dimensionality reduction {.tabset .tabset-fade .tabset-pills}

<details>
  <summary>Experiment Health Details</summary>
  <span>
    <p>The Principal Component Aanalysis (PCA) plot is used to visualise differences between samples that are induced by their intensity profiles. PCA transforms high-dimensional data, like thousands of measured proteins or peptides intensities, into a reduced set of dimensions. The first two dimensions explain the greatest variability between the samples and they are a useful visual tool to confirm known clustering of the samples or to identify potential problems in the data. </p>
    <p>For a healthy experiment we expect:</p>
    <ul>
      <li>Technical Replicates to cluster tightly together.</li>
      <li>Biological Replicates to cluster more than non replicates.</li>
      <li>Clustering of the condition of interest should be visible</li>
    </ul>
    <p> If unexpected clusters occur or replicates don't cluster together it can be due to extra variability introduced by factors such as technical processing, other unexplored biological differences, sample swaps etc... The interpretation and trust in the the differential expression results should take these consideration into a account. If you think that the replicates in the experiment show largely unexpected patterns, it is advisable to request support from an analyst. </p>
    <p>A scree plot shows the amount of variance explained by each dimension extracted by PCA. A high degree of variance in the first few dimensions may suggest large differences between your samples.</p>
  </span>
</details> 

```{r pca-imputed}
## PCA
p=pca_plot_experiment(CompleteIntensityExperiment)


if (params$format == "pdf"){
  p[[1]]
} else {
  ggplotly(p[[1]]) %>% config(displayModeBar = T, 
                        modeBarButtons = list(list('toImage')),
                        displaylogo = F)
}
```

```{r  scree-plot-pca}
if (params$format == "pdf"){
  p[[2]]
} else {
  ggplotly(p[[2]]) %>% config(displayModeBar = T, 
                        modeBarButtons = list(list('toImage')),
                        displaylogo = F)
}
```

```{r mds-impute, eval=FALSE}
# ## MDS
p=mds_plot_experiment(CompleteIntensityExperiment)
p[[1]]
```

```{r eval=FALSE}
p[[2]]
```

## B. Quantitative values CV distributions {.tabset .tabset-fade .tabset-pills}

<details>
  <summary>Coefficient of Variation Details</summary>
  <span>
    <p>The Coefficient of Variation (CV) or Relative Standard Deviation, is calculated by the ratio of the standard deviation to the mean. It is used to measure the precision of a measure, in this case protein/peptide intensity. The plot below shows the distribution of the CVs by experimental conditions where each CV is calculated by protein and by experimental condition. The CV is displayed as %CV, which is the percentage of the mean represented by the standard deviation.  </p>
   <p>For a healthy experiment we expect:</p>
    <ul>
      <li>The distribution of the CVs across conditions to be mostly overlapping, e.g. similar modes</li>
      <li>The modes of the CVs not to be too high, ideally not above 50%</li>
    </ul>
    <p>If the distributions show worringly large %CV, this could affect the quality of the differential expression analysis.<p>
  </span>
</details> 

```{r cv-dist}
plot_condition_cv_distribution(IntensityExperiment)
```


## C. Intensity distribution across runs {.tabset .tabset-fade .tabset-pills}

<details>
  <summary>Relative Log Expression distributions</summary>
  <span>
    <p>It is useful to inspect the distribution of the Relative Log Expression (RLE) values to identify samples with largely unusual distributions. The RLE values for a protein are obtained by centering intensities to the protein medians, where the median is computed using only available intensities, i.e. non zero values. The RLE is computed on the log-transformed data and after applying normalisation, when required. </p>
   <p>For a healthy experiment we expect:</p>
    <ul>
      <li>The RLE boxplots to have a similar median - centered around zero - across all samples </li>
      <li>The RLE boxplots to have a similar width of the boxes across samples </li>
    </ul>
     <p>If some samples show large deviations from the expected behaviour, it can be symptomatic of problems in the pre-processing of those samples.<p>
  </span>
</details> 


```{r rle-plots}

p <- plot_rle_boxplot(IntensityExperiment, CompleteIntensityExperiment, includeImputed = FALSE)

if (params$format == "pdf"){
  p
} else {
  fig <- plotly::ggplotly(p, tooltip = c("y")) %>% 
    plotly::config(displayModeBar = T, 
                   modeBarButtons = list(list('toImage')),
                   displaylogo = F)
  # this code will be needed if you want to make an interactive version
  fig$x$data <- lapply(fig$x$data, FUN = function(x){
    # When creating plot p with ggplot if you specify 
    #fill = cut use x$fill$color instead of $line$color
    x$marker$outliercolor = x$line$color 
    # When creating plot p with ggplot if you specify 
    # fill = cut use x$fill$color instead $line$color
    x$marker$color = x$line$color
    # When creating plot p with ggplot if you specify fill = 
    #cut use x$fill$color instead $line$color
    x$marker$line = x$line$color 
    return(x)
  })

  fig
```
  
# 2. Feature completedness {.tabset .tabset-fade .tabset-pills}

<details>
  <summary>Distribution of missing values by samples and by proteins</summary>
  <span>
    <p> The amount of missing values can be affected by the biological condition or by technical factors and it can vary largely between experiments.</p>
   <p>For a healthy experiment we expect:</p>
    <ul>
      <li>The distribution of missing values replicate to be similar across replicates, especially within the same biological conditions</li>
    </ul>
    <p>There isns't a strict threshold to look for in terms of % of missing values. However, an unusually large amount of missingness in one or a few replicates can be sympthomatic of technial problems and should be taken into account when intepreting the final differential expression results.<p>
  </span>
</details> 

## By sample

```{r sample-missingness}
replicate_missingness_experiment(IntensityExperiment)
```


## By protein

```{r protein-missingness}
protein_missingness_experiment(IntensityExperiment)
```

```{r nprotein-sample}
protein_counts_by_replicate(IntensityExperiment)
```


# 3. Intensity distribution across runs {.tabset .tabset-fade .tabset-pills}

```{r rle-imputed}
plot_rle_boxplot(IntensityExperiment, CompleteIntensityExperiment)
```


# 4. Imputed versus non imputed log2 Intensity values

```{r compare-imputed}
plot_imputed_vs_not(RawDataExperiment = IntensityExperiment,
                    ImputedDataExperiment = CompleteIntensityExperiment)
```
