---
title: "Mass Dynamics Quality Control Report"
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
params:
  listInt: empty
  experiment: experiment_name
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r data-needed, include=FALSE}
library(dplyr)
library(stringr)
library(MassExpression)
library(plotly)

CompleteIntensityExperiment <- params$listInt$CompleteIntensityExperiment
IntensityExperiment <- params$listInt$IntensityExperiment

```


# 1. Experiment Health for: `r params$experiment`

The experiment contains `r nrow(design)` samples; the condition of interest has `r length(unique(design$Condition))` categories: `r paste(unique(design$Condition),collapse=", ")`.  

## A.Dimensionality reduction {.tabset .tabset-fade .tabset-pills}

The data have been log2 transformed and imputed using the MNAR imputation method before PCA. 

## PCA

```{r pca-imputed}
p=pca_plot_experiment(CompleteIntensityExperiment)
#subplot(p[[1]], p[[2]], nrows=2, heights=c(0.7,0.3))
p[[1]]
```

```{r}
p[[2]]
```

## MDS


```{r mds-imputed}
p=mds_plot_experiment(CompleteIntensityExperiment)
#subplot(p[[1]], p[[2]], nrows=2, heights=c(0.7,0.3))
p[[1]]
```

```{r }
p[[2]]
```


## B. Quantitative values CV distributions {.tabset .tabset-fade .tabset-pills}

```{r}
plot_condition_cv_distribution(IntensityExperiment)
```

# 2. Intensity distribution across runs {.tabset .tabset-fade .tabset-pills}

## Imputed data

```{r density-imputed}
plot_density_distr(CompleteIntensityExperiment)
```


```{r}
plot_measurement_boxplot(CompleteIntensityExperiment)
```


```{r}
plot_rle_boxplot(CompleteIntensityExperiment)
```


## Initial data

```{r density-raw}
plot_density_distr(IntensityExperiment, log=TRUE)
```

```{r eval=FALSE}
plot_measurement_boxplot(IntensityExperiment)
```


```{r boxplot-imputed}
plot_rle_boxplot(IntensityExperiment, log = TRUE)
```



# 3. Feature completedness {.tabset .tabset-fade .tabset-pills}

## By sample

```{r sample-missingness}
replicate_missingness_experiment(IntensityExperiment)
```


## By protein

```{r protein-missingness}
protein_missingness_experiment(IntensityExperiment)
```

```{r nprotein-sample}
protein_counts_by_replicate(IntensityExperiment)
```


# 4. Imputed versus non imputed log2 Intensity values

```{r}
plot_imputed_vs_not(RawDataExperiment = IntensityExperiment,
                    ImputedDataExperiment = CompleteIntensityExperiment)
```

# 5. Model QC

## Volcano plots

```{r}
stats <- rowData(CompleteIntensityExperiment)
logfcs <- colnames(stats)[str_detect(colnames(stats), "logFC.")]

for(lfc in logfcs){
  comp_name <- str_remove(lfc, "logFC.")
  adj <- paste0("adj.P.Val.",comp_name)
  adjp <- colnames(stats)[str_detect(colnames(stats), adj)]
  pval <- paste0("P.Value.",comp_name)
  pval_col <- colnames(stats)[str_detect(colnames(stats), pval)]
  comparison.statistics <- data.frame(FoldChange=stats[,lfc],
                                      AdjustedPValue=stats[,adjp], 
                                      PValue = stats[,pval_col],
                                      ProteinId=stats$ProteinId, comparison=comp_name)
  print(plot_volcano(comparison.statistics))
  
}
```


## MA plot

```{r}
for(lfc in logfcs){
  comp_name <- str_remove(lfc, "logFC.")
  comparison.statistics <- data.frame(FoldChange=stats[,lfc],
                                      AveExpr=stats$AveExpr, 
                                      ProteinId=stats$ProteinId, comparison=comp_name)
  print(plot_ma(comparison.statistics))
  
}
```



## Histogram of pvalues

```{r }
pvals <- colnames(stats)[str_detect(colnames(stats), "P.Value.")]

for(pval in pvals){
  comp_name <- str_remove(pval, "P.Value.")
  print(hist(stats[,pval], main=comp_name))
  
}
```





