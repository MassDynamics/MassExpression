---
title: "QCreport"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Steps needed to pre-process the data:
- Filtering 
- Imputation
- Normalization - simplest one including log2

## Initial description of the data 

```{r}
library(MassExpression)
```


```{r}
design <- fragpipe_data$design
intensities <- fragpipe_data$intensities

listIntensityExperiments <- runGenericDiscovery(experimentDesign = design, proteinIntensities = intensities)

CompleteIntensityExperiment <- listIntensityExperiments$CompleteIntensityExperiment
IntensityExperiment <- listIntensityExperiments$IntensityExperiment
```


The data contains `r nrow(design)` experiments; the condition of interest has `r length(unique())`` levels in the condition of interest. 

### Data QC

```{r clustering}
pca_plot_experiment(protein.summarized.experiment)
```

```{r Replicate missingness}
replicate_missingness_experiment(protein.summarized.experiment)
```

```{r Protein Missingness}
# not sure why 1 range isn't being rendered
protein_missingness_experiment(protein.summarized.experiment)
```

```{r}
wide <- as.data.table(assay(protein.summarized.experiment))
wide$ProteinId <- rowData(protein.summarized.experiment)$ProteinId
long <- melt(wide, id.vars = c("ProteinId"), variable.name = "IntensityColumn", value.name = "Intensity")
long <- merge(long, colData(protein.summarized.experiment), by =  "IntensityColumn")
as.data.table(long)
```

```{r Protein Counts}
protein_counts_by_replicate(protein.summarized.experiment)
```

```{r CV Distribution}
plot_protein_cv_distribution(protein.summarized.experiment)
```

### Processing QC

```{r CV Distribution}
plot_protein_cv_distribution(protein.summarized.experiment)
```

```{r Imputation}
plot_imputed_vs_not(prot.int)
```

```{r Measurement Distribution}
plot_measurement_distributions(prot.int)
#plot_measurement_distributions(prot.int, T)
plot_measurement_distributions(prot.int,F, "log2NIntNorm")
plot_measurement_distributions(prot.int, T, "log2NIntNorm")
```


### New QC Concepts:

### Protein Distribution in PCA
Cluster Proteins by Expression

```{r}

res.pca <- PCA((assay(protein.summarized.experiment)), graph = FALSE, ncp = 10)

eig.val <- get_eigenvalue(res.pca)
eig.val <- data.table(dims = rownames(eig.val), eig.val)

samples.pca <- get_pca_ind(res.pca)
samples.coord <- as_data_frame(samples.pca$coord)
#samples.coord$IntensityColumn = colData(protein.summarized.experiment)$IntensityColumn

#samples.coord <- merge(samples.coord, colData(protein.summarized.experiment))
print(colnames(samples.coord))


p <- ggplot(as_data_frame(samples.coord), aes(x = Dim.1, y=Dim.2)) +
  stat_ellipse(geom = "polygon", alpha=0.1) +
  geom_point(size = 3, alpha = 0.7) +
  theme_minimal() +
  scale_x_continuous(str_c("PCA 1 - ", eig.val[dims == "Dim.1", round(variance.percent,1)], "%")) +
  scale_y_continuous(str_c("PCA 2 - ", eig.val[dims == "Dim.2", round(variance.percent,1)], "%"))
p 


p <- ggplot(as_data_frame(samples.coord), aes(x = Dim.2, y=Dim.3)) +
  stat_ellipse(geom = "polygon", alpha=0.1) +
  geom_point(size = 3, alpha = 0.7) +
  theme_minimal() +
  scale_x_continuous(str_c("PCA 2 - ", eig.val[dims == "Dim.2", round(variance.percent,1)], "%")) +
  scale_y_continuous(str_c("PCA 3 - ", eig.val[dims == "Dim.3", round(variance.percent,1)], "%"))
p 

p <- ggplot(as_data_frame(samples.coord), aes(x = Dim.1, y=Dim.2)) +
  stat_ellipse(geom = "polygon", alpha=0.1) +
  geom_point(size = 3, alpha = 0.7) +
  theme_minimal() +
  scale_x_continuous(str_c("PCA 1 - ", eig.val[dims == "Dim.1", round(variance.percent,1)], "%")) +
  scale_y_continuous(str_c("PCA 3 - ", eig.val[dims == "Dim.3", round(variance.percent,1)], "%"))
p 
```

This is clearly the result of missingness which creates clusters in the first dimension. I'm less interested in these clusters so I'll plot the others as well. This is kind of interesting. 

Anyway, I should probably check how the results look after we've normalized and imputed. 

```{r}
colnames(prot.int)

prot.int.tmp <- prot.int[, .(
  ProteinId,
  Condition,
  IntensityColumn,
  log2NIntNorm
)]

prot.int.wide <- dcast(prot.int.tmp, ProteinId ~ IntensityColumn, value.var = "log2NIntNorm")
colnames(prot.int.wide)


res.pca <- PCA(prot.int.wide[,-1], graph = FALSE, ncp = 3)

eig.val <- get_eigenvalue(res.pca)
eig.val <- data.table(dims = rownames(eig.val), eig.val)

samples.pca <- get_pca_ind(res.pca)
samples.coord <- as_data_frame(samples.pca$coord)
#samples.coord$IntensityColumn = colData(protein.summarized.experiment)$IntensityColumn

#samples.coord <- merge(samples.coord, colData(protein.summarized.experiment))
print(colnames(samples.coord))


p <- ggplot(as_data_frame(samples.coord), aes(x = Dim.1, y=Dim.2)) +
  stat_ellipse(geom = "polygon", alpha=0.1) +
  geom_point(size = 3, alpha = 0.7) +
  theme_minimal() +
  scale_x_continuous(str_c("PCA 1 - ", eig.val[dims == "Dim.1", round(variance.percent,1)], "%")) +
  scale_y_continuous(str_c("PCA 2 - ", eig.val[dims == "Dim.2", round(variance.percent,1)], "%"))
p 
```


```{r}
dim(rowData(protein.summarized.experiment))
dim(samples.coord)
dim(prot.int.wide)
samples.coord[,"ProteinId"]= prot.int.wide$ProteinId
colnames(samples.coord)
colnames(rowData(protein.summarized.experiment))
samples.coord <- merge(samples.coord, rowData(protein.summarized.experiment), by = "ProteinId",
                       all.x = T)
colnames(samples.coord)
```

```{r}
library(ggsci)

map2color<-function(x,pal,limits=NULL){
    if(is.null(limits)) limits=range(x, na.rm=T)
    pal[findInterval(x,seq(limits[1],limits[2],length.out=length(pal)+1), all.inside=TRUE)]
}

pal  <- colorRampPalette( c( "blue", "white","red" ) )(100)
map2color(samples.coord$AveExpr, pal)
```

```{r}
library(plotly)
samples.coord <- as_data_frame(samples.coord)
fig <- plot_ly(samples.coord , x = ~Dim.1,  y = ~Dim.2, z = ~Dim.3,
               marker = list(color = ~AveExpr, colorscale = c('#FFE1A1', '#683531'), showscale = TRUE))
fig <- fig %>% add_markers(opacity = 0.5)
fig <- fig %>% layout(scene = list(xaxis = list(title = 'Dim.1'),
                                   yaxis = list(title = 'Dim.2'),
                                   zaxis = list(title = 'Dim.3')))

fig
```




